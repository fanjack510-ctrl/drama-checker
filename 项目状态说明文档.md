# 剧情短视频体检器 - 项目状态说明文档

> 本文档用于向 GPT 或其他 AI 助手说明项目当前状态，便于进行优化和改进

---

## 📋 项目概述

**项目名称**：剧情短视频体检器  
**项目类型**：Web 应用（前后端分离）  
**核心功能**：分析 30-90 秒的剧情/情绪类短视频脚本，给出"是否容易被划走"的体检报告

**目标用户**：短视频内容创作者

---

## 🏗️ 技术架构

### 后端
- **框架**：FastAPI (Python 3.8+)
- **部署平台**：Railway（计划）
- **评分引擎**：规则引擎（已实现）+ 通义千问 LLM（未实现）
- **API 端点**：
  - `GET /health` - 健康检查
  - `POST /api/analyze` - 脚本分析

### 前端
- **技术**：纯 HTML + CSS + 原生 JavaScript（无框架）
- **部署平台**：Vercel（计划）
- **功能**：单页应用，输入脚本 → 调用后端 API → 展示结构化结果

---

## 📁 项目文件结构

```
项目根目录/
├── backend/                    # 后端服务
│   ├── main.py                # FastAPI 主入口（✓ 已实现）
│   ├── scorer_rules.py        # 规则评分引擎（✓ 已实现）
│   ├── schema.py              # Pydantic 数据模型（✓ 已实现）
│   ├── config.py              # 配置管理（✓ 已实现，支持 LLM 配置但未使用）
│   ├── requirements.txt       # Python 依赖（✓ 完整）
│   ├── Procfile               # Railway 启动配置（✓ 已配置）
│   ├── test_api.ps1          # PowerShell 测试脚本（✓ 已创建）
│   ├── test_api.bat          # CMD 测试脚本（✓ 已创建）
│   └── start.py / start.bat  # 本地启动脚本（✓ 已创建）
│
├── index.html                 # 前端单页应用（✓ 已实现）
├── config.js                  # 前端 API 配置（✓ 已创建）
├── 部署步骤清单.md            # 详细部署文档（✓ 已创建）
├── 评分体系设计文档.md        # 评分规则设计（✓ 已创建）
└── 项目状态说明文档.md        # 本文档（当前文件）
```

---

## ✅ 已实现功能

### 1. 后端功能

#### 1.1 规则评分引擎（`backend/scorer_rules.py`）
- ✅ **节奏分析**（35分）
  - 前5秒信息密度检测（12分）
  - 中段推进速度检测（12分）
  - 整体信息密度检测（11分）

- ✅ **情绪曲线分析**（35分）
  - 情绪转折点检测（15分）
  - 情绪递进检测（10分）
  - 情绪多样性检测（10分）

- ✅ **留存钩子分析**（30分）
  - 前5秒吸引力检测（15分）
  - 中段留存点检测（10分）
  - 结尾落点检测（5分）

- ✅ **信号词库**：
  - 冲突词：但是、可是、然而、竟然、居然等
  - 情绪词：愤怒、震惊、崩溃、绝望、惊喜等
  - 悬念句式：为什么、怎么会、到底、究竟等
  - 反差对比：明明...却、本来...结果等

- ✅ **证据片段提取**：自动从原文中提取最多6条证据片段（每条≤12字）

#### 1.2 API 接口（`backend/main.py`）
- ✅ `GET /health` - 健康检查，返回 `{"ok": true}`
- ✅ `POST /api/analyze` - 脚本分析接口
  - 请求体：`{"text": "脚本内容", "mode": "drama_emotion"}`
  - 响应：结构化 JSON（见下方响应格式）
  - 输入验证：文本长度 10-5000 字符
  - 错误处理：400（空/过短）、413（过长）、500（服务器错误）

#### 1.3 数据模型（`backend/schema.py`）
- ✅ `AnalyzeRequest` - 请求模型
- ✅ `AnalyzeResponse` - 响应模型（包含所有评分字段）
- ✅ `IssueItem` - 问题项模型（包含 text 和 reason）
- ✅ `EvidenceItem` - 证据片段模型
- ✅ `HealthResponse` - 健康检查响应

#### 1.4 配置管理（`backend/config.py`）
- ✅ 环境变量读取：`QWEN_API_KEY`、`LLM_ENABLED`、`LLM_API_URL`
- ✅ 默认使用规则引擎
- ✅ 文本长度限制：10-5000 字符
- ⚠️ **注意**：LLM 配置已就绪，但调用逻辑未实现

### 2. 前端功能

#### 2.1 用户界面（`index.html`）
- ✅ 标题和副标题
- ✅ 多行文本输入框（带字数统计）
- ✅ "开始体检"按钮（带 loading 状态）
- ✅ 错误提示区域（网络错误、超时等）

#### 2.2 结果展示
- ✅ **评分展示**：大号数字显示（0-100分）
- ✅ **风险等级**：bad/warn/safe 徽章（带颜色区分）
- ✅ **问题列表**：
  - 🔴 高风险问题（红色边框）
  - 🟡 可优化问题（黄色边框）
- ✅ **证据标签**：每条问题下显示最多2个原文证据片段
- ✅ **信息卡片**：
  - 最容易被划走的位置
  - 观众可能的真实反应
  - 总体优化方向
- ✅ **操作功能**：
  - 复制体检报告（纯文本格式）
  - 导出 JSON（下载文件）
  - 展开/收起原始 JSON（调试用）

#### 2.3 API 调用（`index.html`）
- ✅ 支持配置 API 地址（通过 `config.js` 或硬编码）
- ✅ 10秒超时处理
- ✅ 错误处理（网络错误、500错误、JSON解析错误）
- ✅ Loading 状态管理（禁用按钮和输入框）

#### 2.4 配置管理（`config.js`）
- ✅ 支持通过 `window.__CONFIG__` 配置 API 地址
- ✅ 支持硬编码或相对路径回退

---

## ❌ 未实现功能

### 1. 大模型（LLM）集成
- ❌ **通义千问 API 调用**：`backend/main.py` 第 61-63 行显示 LLM 模式为预留
- ❌ **LLM 评分引擎**：缺少 `llm_scorer.py` 文件
- ❌ **失败回退机制**：虽然代码中有回退逻辑，但 LLM 调用未实现，无法测试

**当前状态**：
```python
# backend/main.py 第 57-63 行
if DEFAULT_ENGINE == "rule":
    result = score_by_rules(text)
else:
    # LLM 模式（预留，暂未实现）
    # 这里可以调用 LLM API
    result = score_by_rules(text)  # 暂时回退到规则引擎
```

**需要实现**：
- 创建 `backend/llm_scorer.py`
- 实现通义千问 API 调用
- 解析 LLM 返回的 JSON
- 转换为 `AnalyzeResponse` 格式
- 实现失败回退到规则引擎

### 2. 部署相关
- ⚠️ **未部署到 Railway**：后端代码已就绪，但未实际上线
- ⚠️ **未部署到 Vercel**：前端代码已就绪，但未实际上线
- ⚠️ **API 地址未配置**：`config.js` 中的 `API_BASE_URL` 为空

### 3. 功能增强（可选）
- ❌ 用户历史记录（需要数据库）
- ❌ 批量分析功能
- ❌ 评分结果对比
- ❌ 导出 PDF 报告

---

## 🔧 已知问题与限制

### 1. 规则引擎限制
- **评分稳定性**：基于文本信号匹配，相同脚本多次评分可能略有差异（±5分内）
- **信号词库有限**：当前词库可能无法覆盖所有表达方式
- **无法理解语义**：只能识别显式的冲突词、情绪词等，无法理解深层含义

### 2. 前端限制
- **无状态管理**：刷新页面后数据丢失
- **无错误重试**：网络错误后需要手动重试
- **无输入验证**：前端未验证文本长度（依赖后端）

### 3. 性能考虑
- **同步请求**：前端等待后端响应，无异步优化
- **无缓存机制**：相同脚本会重复分析

---

## 📊 API 响应格式

### 成功响应示例

```json
{
  "score": 65,
  "risk_level": "warn",
  "summary": [
    "前5秒缺乏明确冲突或悬念，容易让人划走",
    "情绪曲线较为平直，缺少明显的转折点",
    "中段节奏偏慢，信息密度不够",
    "结尾缺乏情绪落点，没有留下思考空间"
  ],
  "issues_high": [
    {
      "text": "前5秒缺乏吸引力，容易被划走",
      "reason": "前5秒无冲突、无悬念、无反差、无强情绪"
    }
  ],
  "issues_mid": [
    {
      "text": "中段节奏可以更快，信息密度有待提升",
      "reason": "中段存在连续2句平铺直叙"
    }
  ],
  "risky_section": "前段",
  "viewer_reaction": "如果我是观众，我会在前5秒觉得没什么意思就划走了",
  "directions": [
    "在开头建立明确的冲突或悬念",
    "增加至少一次情绪或剧情转折",
    "提升中段的信息密度和节奏感"
  ],
  "evidence": [
    {
      "text": "今天天气真好",
      "position": "前段",
      "reason": "包含冲突词"
    }
  ],
  "meta": {
    "version": "1.0.0",
    "engine": "rule"
  }
}
```

### 错误响应示例

```json
{
  "detail": "文本内容不能为空"
}
```

---

## 🎯 评分规则说明

### 评分维度（总分100分）

1. **节奏（Rhythm）** - 35分
   - 前5秒信息密度：12分
   - 中段推进速度：12分
   - 整体信息密度：11分

2. **情绪曲线（Emotion Curve）** - 35分
   - 情绪转折点：15分
   - 情绪递进：10分
   - 情绪多样性：10分

3. **留存钩子（Retention Triggers）** - 30分
   - 前5秒吸引力：15分
   - 中段留存点：10分
   - 结尾落点：5分

### 风险等级判定

- **safe**：总分 ≥ 75
- **warn**：总分 60-74
- **bad**：总分 < 60

详细评分规则见 `评分体系设计文档.md`

---

## 🚀 部署状态

### 后端（Railway）
- ✅ 代码已就绪
- ✅ `Procfile` 已配置
- ✅ `requirements.txt` 完整
- ⚠️ **未实际上线**：需要按照 `部署步骤清单.md` 操作

### 前端（Vercel）
- ✅ 代码已就绪
- ✅ `index.html` 在根目录
- ⚠️ **未实际上线**：需要按照 `部署步骤清单.md` 操作
- ⚠️ **API 地址未配置**：`config.js` 中 `API_BASE_URL` 为空

---

## 📝 代码质量说明

### 优点
- ✅ 代码结构清晰，模块化良好
- ✅ 类型提示完整（Pydantic 模型）
- ✅ 错误处理完善
- ✅ 文档齐全（部署文档、评分规则文档）

### 待改进
- ⚠️ CORS 配置允许所有来源（`allow_origins=["*"]`），生产环境应限制
- ⚠️ 缺少单元测试
- ⚠️ 缺少 API 限流机制
- ⚠️ 日志记录不完善

---

## 🔄 待优化方向

### 高优先级
1. **实现 LLM 集成**
   - 创建 `llm_scorer.py`
   - 实现通义千问 API 调用
   - 实现失败回退机制

2. **完成部署**
   - 部署后端到 Railway
   - 部署前端到 Vercel
   - 配置 API 地址

3. **CORS 安全优化**
   - 将 `allow_origins=["*"]` 改为具体域名列表

### 中优先级
4. **前端体验优化**
   - 添加输入验证（前端检查文本长度）
   - 添加错误重试机制
   - 优化 loading 动画

5. **评分引擎优化**
   - 扩展信号词库
   - 优化评分算法稳定性
   - 添加更多评分维度

### 低优先级
6. **功能增强**
   - 添加历史记录（需要数据库）
   - 添加批量分析
   - 添加评分对比功能

---

## 🧪 测试状态

### 本地测试
- ✅ 后端健康检查：`http://localhost:8000/health` ✓
- ✅ 后端 API：`POST /api/analyze` ✓
- ✅ 前端页面：本地打开 `index.html` ✓
- ⚠️ 前后端联调：需要配置 API 地址

### 测试脚本
- ✅ `backend/test_api.ps1` - PowerShell 测试脚本
- ✅ `backend/test_api.bat` - CMD 测试脚本

---

## 📚 相关文档

1. **`部署步骤清单.md`** - 详细的部署步骤（从 0 到上线）
2. **`评分体系设计文档.md`** - 完整的评分规则设计
3. **`backend/README.md`** - 后端使用说明

---

## 💡 给 GPT 的优化建议

### 1. 代码优化
- 检查 `backend/scorer_rules.py` 中的评分逻辑是否可以优化
- 检查 `index.html` 中的 JavaScript 代码是否可以重构
- 添加类型检查和错误边界

### 2. 性能优化
- 前端：添加防抖（debounce）避免频繁请求
- 后端：添加缓存机制（相同脚本不重复分析）
- 优化 JSON 序列化性能

### 3. 用户体验优化
- 添加输入示例和提示
- 优化错误提示文案
- 添加键盘快捷键支持

### 4. 安全性优化
- CORS 配置限制具体域名
- 添加 API 限流（防止滥用）
- 输入内容安全检查（防止 XSS）

### 5. 可维护性优化
- 添加单元测试
- 添加集成测试
- 完善日志记录
- 添加监控和告警

---

## 📞 项目信息

**创建时间**：2024年  
**最后更新**：2024年  
**当前版本**：1.0.0  
**状态**：开发完成，待部署上线

---

## 🎯 总结

这是一个**功能完整但未上线**的 Web 应用：

✅ **已完成**：
- 规则评分引擎（完整实现）
- 前后端代码（完整实现）
- API 接口（完整实现）
- 部署文档（完整）

❌ **待完成**：
- LLM 集成（代码框架已就绪，调用逻辑未实现）
- 实际上线部署（Railway + Vercel）
- API 地址配置

⚠️ **待优化**：
- CORS 安全配置
- 代码质量和测试
- 用户体验增强

---

**文档生成时间**：2024年  
**文档用途**：供 GPT 或其他 AI 助手理解项目状态，进行优化和改进

